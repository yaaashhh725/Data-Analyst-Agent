<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Analyst Agent</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        h1, h2 {
            text-align: center;
            color: #2c3e50;
        }
        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        textarea, input[type="file"] {
            width: 100%;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea {
            min-height: 200px;
            resize: vertical;
        }
        button {
            padding: 12px 20px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .info-text {
            font-size: 0.9rem;
            color: #555;
            margin-top: -10px;
            margin-bottom: 5px;
        }
        .results-container, .debug-container {
            margin-top: 25px;
        }
        pre {
            background-color: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 4px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }
        .loader {
            text-align: center;
            padding: 20px;
            display: none; /* Hidden by default */
        }
        .debug-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Data Analyst Agent </h1>
        
        <form id="upload-form">
            <label for="questions"><strong>1. Enter Your Questions (Mandatory)</strong></label>
            <textarea id="questions" name="questions" required placeholder="Scrape the list of highest grossing films from Wikipedia. It is at the URL:
https://en.wikipedia.org/wiki/List_of_highest-grossing_films

Answer the following questions and respond with a JSON array of strings containing the answer.

1. How many $2 bn movies were released before 2000?
2. Which is the earliest film that grossed over $1.5 bn?
3. What's the correlation between the Rank and Peak?
4. Draw a scatterplot of Rank and Peak along with a dotted red regression line through it. Return as a base-64 encoded data URI."></textarea>
            
            <label for="extra-files"><strong>2. Upload Data Files (Optional)</strong></label>
             <p class="info-text">
                You can upload optional data files that your questions refer to. <br>
                Supported formats: CSV, JSON, YAML, SQL, Parquet, PDF, HTML, and images.
            </p>
            <input type="file" id="extra-files" name="extra_files" multiple>
            
            <button type="submit">Execute Task</button>
        </form>

        <div id="loader" class="loader">
            <p>Processing... This may take a moment. Please wait. üôè</p>
        </div>
        
        <div class="results-container">
            <h2>Result</h2>
            <pre id="main-output">Awaiting submission...</pre>
        </div>

        <hr>

        <div class="debug-container">
            <h2>Utility & Debug Endpoints</h2>
            <div class="debug-buttons">
                <button data-endpoint="/task-breakdown">Test Task Breakdown</button>
                <button data-endpoint="/final-result">Get Last Final Result</button>
                <button data-endpoint="/run-script">Run try.py</button>
                <button data-endpoint="/debug">Get Debug Info</button>
            </div>
            <pre id="debug-output">Click a button to see its output.</pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('upload-form');
            const questionsTextarea = document.getElementById('questions');
            const extraFilesInput = document.getElementById('extra-files');
            const loader = document.getElementById('loader');
            const mainOutput = document.getElementById('main-output');
            const debugOutput = document.getElementById('debug-output');
            const debugButtons = document.querySelector('.debug-buttons');

            // Set the base URL for the API
            const API_BASE_URL = 'http://localhost:8000';

            // Handle the main form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                loader.style.display = 'block';
                mainOutput.textContent = 'Processing...';

                const formData = new FormData();

                // 1. Create a File object from the textarea content for 'questions.txt'
                const questionsContent = questionsTextarea.value;
                const questionsBlob = new Blob([questionsContent], { type: 'text/plain' });
                const questionsFile = new File([questionsBlob], 'questions.txt', { type: 'text/plain' });
                formData.append('questions.txt', questionsFile);

                // 2. Append any other files the user selected
                for (const file of extraFilesInput.files) {
                    formData.append(file.name, file);
                }
                
                try {
                    const response = await fetch(`${API_BASE_URL}/upload`, {
                        method: 'POST',
                        body: formData,
                    });

                    const result = await response.json();
                    
                    if (!response.ok) {
                        throw new Error(result.detail || `HTTP error! Status: ${response.status}`);
                    }
                    
                    mainOutput.textContent = JSON.stringify(result, null, 2);

                } catch (error) {
                    mainOutput.textContent = `Error: ${error.message}`;
                    console.error('Upload failed:', error);
                } finally {
                    loader.style.display = 'none';
                }
            });

            // Generic handler for all debug buttons
            debugButtons.addEventListener('click', async (e) => {
                if (e.target.tagName === 'BUTTON') {
                    const endpoint = e.target.dataset.endpoint;
                    debugOutput.textContent = `Fetching from ${endpoint}...`;

                    try {
                        const response = await fetch(`${API_BASE_URL}${endpoint}`);
                        const result = await response.json();

                        if (!response.ok) {
                           throw new Error(result.detail || `HTTP error! Status: ${response.status}`);
                        }

                        debugOutput.textContent = JSON.stringify(result, null, 2);

                    } catch (error) {
                        debugOutput.textContent = `Error: ${error.message}`;
                        console.error(`Failed to fetch from ${endpoint}:`, error);
                    }
                }
            });
        });
    </script>

</body>
</html>